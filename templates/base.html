<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Performance Rating{% endblock %}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        nav {
            margin-top: 15px;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            margin-right: 10px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            transition: background 0.3s;
        }

        nav a:hover, nav a.active {
            background: rgba(255,255,255,0.2);
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: 700;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .rating-stars {
            color: #ffa726;
            font-size: 18px;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Employee name clickable style */
        .employee-name {
            cursor: pointer;
            color: #667eea;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
        }

        .employee-name:hover {
            color: #5568d3;
            text-decoration: underline;
        }

        /* Employee detail modal */
        .employee-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s;
        }

        .employee-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .employee-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .employee-modal-header {
            padding: 20px 25px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .employee-modal-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 20px;
            font-weight: 600;
        }

        .employee-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .employee-modal-close:hover {
            background: #e0e0e0;
            color: #2c3e50;
        }

        .employee-modal-body {
            padding: 25px;
        }

        .employee-modal-section {
            margin-bottom: 25px;
        }

        .employee-modal-section h4 {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .employee-modal-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .employee-modal-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .employee-modal-field.full-width {
            grid-column: 1 / -1;
        }

        .employee-modal-field label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        .employee-modal-field .value {
            font-size: 14px;
            color: #2c3e50;
            padding: 8px 0;
        }

        .employee-modal-field input,
        .employee-modal-field textarea {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .employee-modal-field input:focus,
        .employee-modal-field textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .employee-modal-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .employee-modal-field input.invalid {
            border-color: #e74c3c;
            background-color: #fee;
        }

        .employee-modal-field .error {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 3px;
        }

        .employee-modal-footer {
            padding: 15px 25px;
            border-top: 2px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .employee-modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .employee-modal-footer .btn-cancel {
            background: #e0e0e0;
            color: #666;
        }

        .employee-modal-footer .btn-cancel:hover {
            background: #d0d0d0;
        }

        .employee-modal-footer .btn-save {
            background: #667eea;
            color: white;
        }

        .employee-modal-footer .btn-save:hover {
            background: #5568d3;
        }

        .employee-modal-footer .btn-save:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .employee-modal-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .employee-modal-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal tenets styling */
        .modal-tenets-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-tenet-column {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
        }

        .modal-tenet-column h5 {
            font-size: 12px;
            color: #666;
            margin: 0 0 10px 0;
            font-weight: 600;
            text-transform: uppercase;
        }

        .modal-tenet-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 0;
            font-size: 12px;
        }

        .modal-tenet-item input[type="checkbox"] {
            cursor: pointer;
            flex-shrink: 0;
        }

        .modal-tenet-item label {
            cursor: pointer;
            flex: 1;
            font-size: 12px;
            font-weight: normal;
            color: #2c3e50;
            margin: 0;
        }

        .modal-tenet-item.disabled {
            opacity: 0.5;
        }

        .modal-tenet-count {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .modal-tenet-count.warning {
            color: #e74c3c;
        }

        /* Filter Panel Styles */
        .filter-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.2s;
        }

        .filter-toggle:hover {
            background: #5568d3;
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        .filter-toggle.active {
            background: #ff9800;
        }

        .filter-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            max-height: calc(100vh - 100px);
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 9998;
            display: none;
            overflow-y: auto;
        }

        .filter-panel.show {
            display: block;
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .filter-panel-header {
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .filter-panel-header h3 {
            margin: 0;
            font-size: 18px;
            color: #2c3e50;
        }

        .filter-panel-body {
            padding: 20px;
        }

        .filter-section {
            margin-bottom: 20px;
        }

        .filter-section label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .filter-section .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .filter-section .checkbox-label:hover {
            background: #e8e9ea;
        }

        .filter-section .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .filter-section select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            max-height: 150px;
        }

        .filter-section select:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-preview {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 13px;
            color: #2c3e50;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .filter-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-actions .btn-apply {
            background: #667eea;
            color: white;
        }

        .filter-actions .btn-apply:hover {
            background: #5568d3;
        }

        .filter-actions .btn-clear {
            background: #e0e0e0;
            color: #666;
        }

        .filter-actions .btn-clear:hover {
            background: #d0d0d0;
        }

        /* Filter Banner */
        .filter-banner {
            background: #ff9800;
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 20px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .filter-banner a {
            color: white;
            text-decoration: underline;
            font-weight: 600;
        }

        .filter-banner a:hover {
            text-decoration: none;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <header>
        <div class="container">
            <h1>Performance Rating System</h1>
            <nav>
                <a href="{{ url_for('index') }}" {% if request.endpoint == 'index' %}class="active"{% endif %}>Dashboard</a>
                <a href="{{ url_for('rate_page') }}" {% if request.endpoint == 'rate_page' %}class="active"{% endif %}>Rate Team</a>
                <a href="{{ url_for('analytics') }}" {% if request.endpoint == 'analytics' %}class="active"{% endif %}>Analytics</a>
                <a href="{{ url_for('bonus_calculation') }}" {% if request.endpoint == 'bonus_calculation' %}class="active"{% endif %}>Bonus Calculation</a>
                <a href="{{ url_for('export_page') }}" {% if request.endpoint == 'export_page' %}class="active"{% endif %}>Export</a>
            </nav>
        </div>
    </header>

    <!-- Filter Toggle Button -->
    <button class="filter-toggle {% if filter_info is defined and filter_info.active %}active{% endif %}"
            onclick="toggleFilterPanel()"
            id="filterToggle">
        üîç Filters{% if filter_info is defined and filter_info.active %} ({{ filter_info.hidden_count }}){% endif %}
    </button>

    <!-- Filter Panel -->
    <div class="filter-panel" id="filterPanel">
        <div class="filter-panel-header">
            <h3>Filter Employees</h3>
        </div>
        <div class="filter-panel-body">
            <!-- Quick filter: Exclude managers -->
            <div class="filter-section">
                <label class="checkbox-label">
                    <input type="checkbox" id="excludeManagers"
                           {% if filter_info is defined and filter_info.params.exclude_managers %}checked{% endif %}>
                    <span>Exclude managers (people with direct reports)</span>
                </label>
            </div>

            <!-- Filter by job title -->
            <div class="filter-section">
                <label for="titleSelect">Exclude by Job Title:</label>
                <select id="titleSelect" multiple size="6">
                    {% if filter_info is defined %}
                        {% for title in filter_info.available_titles %}
                        <option value="{{ title }}"
                                {% if title in filter_info.params.exclude_titles %}selected{% endif %}>
                            {{ title }}
                        </option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>

            <!-- Filter by name -->
            <div class="filter-section">
                <label for="nameSelect">Exclude by Name:</label>
                <select id="nameSelect" multiple size="6">
                    {% if filter_info is defined %}
                        {% for name in filter_info.available_names %}
                        <option value="{{ name }}"
                                {% if name in filter_info.params.exclude_names %}selected{% endif %}
                                data-employee-name="{{ name }}">
                            {{ name }}
                        </option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>

            <!-- Preview -->
            <div class="filter-preview" id="filterPreview">
                {% if filter_info is defined %}
                    Preview: {{ filter_info.hidden_count }} hidden ({{ filter_info.filtered_count }} shown)
                {% else %}
                    Select filters to preview
                {% endif %}
            </div>

            <!-- Actions -->
            <div class="filter-actions">
                <button class="btn-apply" onclick="applyFilters()">Apply Filters</button>
                <button class="btn-clear" onclick="clearFilters()">Clear All</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Filter Banner -->
        {% if filter_info is defined and filter_info.active %}
        <div class="filter-banner">
            ‚ö†Ô∏è Filters Active: {{ filter_info.hidden_count }} employee(s) hidden
            <a href="#" onclick="clearFilters(); return false;">Clear filters</a>
        </div>
        {% endif %}

        {% block content %}{% endblock %}
    </div>

    <!-- Employee Detail Modal -->
    <div id="employeeModal" class="employee-modal">
        <div class="employee-modal-content">
            <div class="employee-modal-header">
                <h3 id="employeeModalTitle">Employee Details</h3>
                <button class="employee-modal-close" onclick="closeEmployeeModal()">&times;</button>
            </div>
            <div class="employee-modal-body" id="employeeModalBody">
                <div class="employee-modal-loading">
                    <div class="employee-modal-spinner"></div>
                    <div>Loading employee details...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Filter employee metadata for UI updates
        {% if filter_info is defined %}
        const filterEmployeeMetadata = {
            {% for name in filter_info.available_names %}
            "{{ name }}": {
                isManager: {{ 'true' if name in filter_info.get('managers', []) else 'false' }},
                jobTitle: "{{ filter_info.get('employee_titles', {}).get(name, '') }}"
            }{{ ',' if not loop.last else '' }}
            {% endfor %}
        };
        {% else %}
        const filterEmployeeMetadata = {};
        {% endif %}

        // Employee Modal Functions
        let currentEmployeeId = null;
        let originalEmployeeData = null;
        let modalTenetsConfig = null;
        let modalHasUnsavedChanges = false;

        // Load tenets configuration for modal
        function loadModalTenets() {
            if (modalTenetsConfig) {
                return Promise.resolve(modalTenetsConfig);
            }
            return fetch('/api/tenets')
                .then(response => response.json())
                .then(data => {
                    modalTenetsConfig = data;
                    return data;
                })
                .catch(error => {
                    console.error('Error loading tenets:', error);
                    return null;
                });
        }

        function openEmployeeModal(employeeName) {
            const modal = document.getElementById('employeeModal');
            const modalBody = document.getElementById('employeeModalBody');
            const modalTitle = document.getElementById('employeeModalTitle');

            // Show loading state
            modalBody.innerHTML = `
                <div class="employee-modal-loading">
                    <div class="employee-modal-spinner"></div>
                    <div>Loading employee details...</div>
                </div>
            `;
            modalTitle.textContent = 'Employee Details';
            modal.classList.add('active');

            // Load tenets and employee data in parallel
            Promise.all([
                loadModalTenets(),
                fetch(`/api/employee/${encodeURIComponent(employeeName)}`).then(r => r.json())
            ])
            .then(([tenets, data]) => {
                if (data.success) {
                    renderEmployeeModal(data.employee);
                } else {
                    modalBody.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #e74c3c;">
                            <p>Error loading employee data: ${data.error}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                modalBody.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #e74c3c;">
                        <p>Network error: ${error.message}</p>
                    </div>
                `;
            });
        }

        function renderEmployeeModal(employee) {
            currentEmployeeId = employee['Associate ID'];
            originalEmployeeData = {...employee};

            const modalTitle = document.getElementById('employeeModalTitle');
            const modalBody = document.getElementById('employeeModalBody');

            modalTitle.textContent = employee.Associate;

            // Parse existing tenets
            let existingStrengths = [];
            let existingImprovements = [];
            try {
                if (employee.tenets_strengths) {
                    existingStrengths = typeof employee.tenets_strengths === 'string'
                        ? JSON.parse(employee.tenets_strengths)
                        : employee.tenets_strengths;
                }
                if (employee.tenets_improvements) {
                    existingImprovements = typeof employee.tenets_improvements === 'string'
                        ? JSON.parse(employee.tenets_improvements)
                        : employee.tenets_improvements;
                }
            } catch (e) {
                console.error('Error parsing tenets:', e);
            }

            // Generate tenets HTML
            let tenetsHTML = '';
            if (modalTenetsConfig && modalTenetsConfig.tenets) {
                const activeTenets = modalTenetsConfig.tenets.filter(t => t.active);
                const strengthsHTML = activeTenets.map(tenet => `
                    <div class="modal-tenet-item">
                        <input type="checkbox"
                               id="modal_strength_${tenet.id}"
                               value="${tenet.id}"
                               data-tenet-type="strengths"
                               ${existingStrengths.includes(tenet.id) ? 'checked' : ''}>
                        <label for="modal_strength_${tenet.id}">${tenet.name}</label>
                    </div>
                `).join('');

                const improvementsHTML = activeTenets.map(tenet => `
                    <div class="modal-tenet-item">
                        <input type="checkbox"
                               id="modal_improvement_${tenet.id}"
                               value="${tenet.id}"
                               data-tenet-type="improvements"
                               ${existingImprovements.includes(tenet.id) ? 'checked' : ''}>
                        <label for="modal_improvement_${tenet.id}">${tenet.name}</label>
                    </div>
                `).join('');

                tenetsHTML = `
                    <div class="employee-modal-section">
                        <h4>Team Tenets (Select 3 of each)</h4>
                        <div class="modal-tenets-grid">
                            <div class="modal-tenet-column">
                                <h5>Strengths</h5>
                                ${strengthsHTML}
                                <div class="modal-tenet-count" id="modal_strengths_count">${existingStrengths.length} / 3 selected</div>
                            </div>
                            <div class="modal-tenet-column">
                                <h5>Areas for Improvement</h5>
                                ${improvementsHTML}
                                <div class="modal-tenet-count" id="modal_improvements_count">${existingImprovements.length} / 3 selected</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            modalBody.innerHTML = `
                <div class="employee-modal-section">
                    <h4>Basic Information</h4>
                    <div class="employee-modal-grid">
                        <div class="employee-modal-field">
                            <label>Associate ID</label>
                            <div class="value">${employee['Associate ID']}</div>
                        </div>
                        <div class="employee-modal-field">
                            <label>Job Profile</label>
                            <div class="value">${employee['Current Job Profile'] || 'N/A'}</div>
                        </div>
                        <div class="employee-modal-field">
                            <label>Supervisory Organization</label>
                            <div class="value">${employee['Supervisory Organization'] || 'N/A'}</div>
                        </div>
                        <div class="employee-modal-field">
                            <label>Currency</label>
                            <div class="value">${employee.Currency || 'N/A'}</div>
                        </div>
                    </div>
                </div>

                <div class="employee-modal-section">
                    <h4>Performance Rating</h4>
                    <div class="employee-modal-grid">
                        <div class="employee-modal-field">
                            <label>Rating % (0-200)</label>
                            <input type="number"
                                   id="modal_rating_percent"
                                   min="0"
                                   max="200"
                                   step="1"
                                   value="${employee.performance_rating_percent || ''}"
                                   placeholder="0-200">
                            <span class="error" id="modal_rating_error"></span>
                        </div>
                        <div class="employee-modal-field">
                            <label>Last Updated</label>
                            <div class="value">${employee.last_updated || 'Not yet rated'}</div>
                        </div>
                        <div class="employee-modal-field full-width">
                            <label>Justification</label>
                            <textarea id="modal_justification" placeholder="Explain the rating...">${employee.justification || ''}</textarea>
                        </div>
                    </div>
                </div>

                <div class="employee-modal-section">
                    <h4>Development & Mentoring</h4>
                    <div class="employee-modal-grid">
                        <div class="employee-modal-field">
                            <label>Mentor</label>
                            <input type="text"
                                   id="modal_mentor"
                                   value="${employee.mentor || ''}"
                                   placeholder="Who is mentoring this person?">
                        </div>
                        <div class="employee-modal-field">
                            <label>Mentee(s)</label>
                            <input type="text"
                                   id="modal_mentees"
                                   value="${employee.mentees || ''}"
                                   placeholder="Who is this person mentoring?">
                        </div>
                    </div>
                </div>

                ${tenetsHTML}

                <div class="employee-modal-footer">
                    <button class="btn-cancel" onclick="closeEmployeeModal()">Close</button>
                    <button class="btn-save" onclick="saveEmployeeModal()">Save Changes</button>
                </div>
            `;

            // Reset dirty state
            modalHasUnsavedChanges = false;

            // Add validation listener
            const ratingInput = document.getElementById('modal_rating_percent');
            ratingInput.addEventListener('input', validateModalRating);

            // Add tenets listeners
            if (modalTenetsConfig) {
                setupModalTenetsListeners();
            }

            // Add change listeners to track unsaved changes
            setupModalChangeTracking();
        }

        function setupModalTenetsListeners() {
            const strengthCheckboxes = document.querySelectorAll('input[data-tenet-type="strengths"]');
            const improvementCheckboxes = document.querySelectorAll('input[data-tenet-type="improvements"]');

            const updateTenetCounts = () => {
                const strengthsChecked = Array.from(strengthCheckboxes).filter(cb => cb.checked);
                const improvementsChecked = Array.from(improvementCheckboxes).filter(cb => cb.checked);

                const strengthsCount = document.getElementById('modal_strengths_count');
                const improvementsCount = document.getElementById('modal_improvements_count');

                if (strengthsCount) {
                    strengthsCount.textContent = `${strengthsChecked.length} / 3 selected`;
                    strengthsCount.className = 'modal-tenet-count';
                    if (strengthsChecked.length > 0 && strengthsChecked.length !== 3) {
                        strengthsCount.classList.add('warning');
                    }
                }

                if (improvementsCount) {
                    improvementsCount.textContent = `${improvementsChecked.length} / 3 selected`;
                    improvementsCount.className = 'modal-tenet-count';
                    if (improvementsChecked.length > 0 && improvementsChecked.length !== 3) {
                        improvementsCount.classList.add('warning');
                    }
                }

                // Disable checkboxes if already selected in other list
                const strengthValues = new Set(strengthsChecked.map(cb => cb.value));
                const improvementValues = new Set(improvementsChecked.map(cb => cb.value));

                strengthCheckboxes.forEach(cb => {
                    const item = cb.closest('.modal-tenet-item');
                    if (improvementValues.has(cb.value) && !cb.checked) {
                        cb.disabled = true;
                        item.classList.add('disabled');
                    } else if (strengthsChecked.length >= 3 && !cb.checked) {
                        cb.disabled = true;
                        item.classList.add('disabled');
                    } else {
                        cb.disabled = false;
                        item.classList.remove('disabled');
                    }
                });

                improvementCheckboxes.forEach(cb => {
                    const item = cb.closest('.modal-tenet-item');
                    if (strengthValues.has(cb.value) && !cb.checked) {
                        cb.disabled = true;
                        item.classList.add('disabled');
                    } else if (improvementsChecked.length >= 3 && !cb.checked) {
                        cb.disabled = true;
                        item.classList.add('disabled');
                    } else {
                        cb.disabled = false;
                        item.classList.remove('disabled');
                    }
                });
            };

            strengthCheckboxes.forEach(cb => cb.addEventListener('change', updateTenetCounts));
            improvementCheckboxes.forEach(cb => cb.addEventListener('change', updateTenetCounts));

            // Initial update
            updateTenetCounts();
        }

        function setupModalChangeTracking() {
            // Mark form as dirty when any input changes
            const markDirty = () => { modalHasUnsavedChanges = true; };

            // Track text inputs and textareas
            const ratingInput = document.getElementById('modal_rating_percent');
            const justificationInput = document.getElementById('modal_justification');
            const mentorInput = document.getElementById('modal_mentor');
            const menteesInput = document.getElementById('modal_mentees');

            if (ratingInput) ratingInput.addEventListener('input', markDirty);
            if (justificationInput) justificationInput.addEventListener('input', markDirty);
            if (mentorInput) mentorInput.addEventListener('input', markDirty);
            if (menteesInput) menteesInput.addEventListener('input', markDirty);

            // Track tenet checkboxes
            const tenetCheckboxes = document.querySelectorAll('input[data-tenet-type]');
            tenetCheckboxes.forEach(cb => cb.addEventListener('change', markDirty));
        }

        function validateModalRating() {
            const ratingInput = document.getElementById('modal_rating_percent');
            const errorSpan = document.getElementById('modal_rating_error');
            const value = ratingInput.value.trim();

            ratingInput.classList.remove('invalid');
            errorSpan.textContent = '';

            if (value === '') {
                return true;
            }

            const numValue = parseFloat(value);

            if (isNaN(numValue)) {
                ratingInput.classList.add('invalid');
                errorSpan.textContent = 'Must be a number';
                return false;
            }

            if (numValue < 0 || numValue > 200) {
                ratingInput.classList.add('invalid');
                errorSpan.textContent = 'Must be between 0 and 200';
                return false;
            }

            return true;
        }

        function saveEmployeeModal() {
            if (!validateModalRating()) {
                return;
            }

            const saveButton = document.querySelector('.employee-modal-footer .btn-save');
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';

            // Collect selected tenets
            const strengthCheckboxes = document.querySelectorAll('input[data-tenet-type="strengths"]:checked');
            const improvementCheckboxes = document.querySelectorAll('input[data-tenet-type="improvements"]:checked');

            const tenetsStrengths = Array.from(strengthCheckboxes).map(cb => cb.value);
            const tenetsImprovements = Array.from(improvementCheckboxes).map(cb => cb.value);

            const data = {
                associate_name: originalEmployeeData.Associate,
                rating_percent: document.getElementById('modal_rating_percent').value,
                justification: document.getElementById('modal_justification').value,
                mentor: document.getElementById('modal_mentor').value,
                mentees: document.getElementById('modal_mentees').value,
                tenets_strengths: tenetsStrengths,
                tenets_improvements: tenetsImprovements
            };

            fetch('/api/rate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Reset dirty flag since changes are saved
                    modalHasUnsavedChanges = false;
                    // Show success and close modal
                    saveButton.textContent = 'Saved!';
                    setTimeout(() => {
                        closeEmployeeModal();
                        // Reload page to reflect changes
                        window.location.reload();
                    }, 500);
                } else {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save Changes';
                    alert('Error saving: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                saveButton.disabled = false;
                saveButton.textContent = 'Save Changes';
                alert('Network error: ' + error.message);
            });
        }

        function closeEmployeeModal() {
            // Check for unsaved changes
            if (modalHasUnsavedChanges) {
                const confirmClose = confirm('You have unsaved changes. Close without saving?');
                if (!confirmClose) {
                    return; // Don't close the modal
                }
            }

            // Close the modal
            const modal = document.getElementById('employeeModal');
            modal.classList.remove('active');
            currentEmployeeId = null;
            originalEmployeeData = null;
            modalHasUnsavedChanges = false; // Reset dirty flag
        }

        // Close modal when clicking outside of it
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('employeeModal');
            if (event.target === modal) {
                closeEmployeeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('employeeModal');
                if (modal.classList.contains('active')) {
                    closeEmployeeModal();
                }
            }
        });

        // Global function to make employee names clickable
        function makeEmployeeNamesClickable() {
            const employeeNameElements = document.querySelectorAll('.employee-name');
            employeeNameElements.forEach(element => {
                element.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const employeeName = this.getAttribute('data-employee-name');
                    if (employeeName) {
                        openEmployeeModal(employeeName);
                    }
                });
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', makeEmployeeNamesClickable);

        // Filter Panel Management
        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            panel.classList.toggle('show');

            // Update indicators when opening panel
            if (panel.classList.contains('show')) {
                updateNameDropdownIndicators();
            }
        }

        // Update name dropdown with visual indicators
        function updateNameDropdownIndicators() {
            const nameSelect = document.getElementById('nameSelect');
            const excludeManagers = document.getElementById('excludeManagers');
            const titleSelect = document.getElementById('titleSelect');

            if (!nameSelect || !excludeManagers || !titleSelect) return;

            // Get currently manually selected names to preserve selection
            const selectedNames = Array.from(nameSelect.selectedOptions).map(o => o.value);

            // Get excluded titles
            const excludedTitles = Array.from(titleSelect.selectedOptions).map(o => o.value);

            // Rebuild options with indicators and auto-selection
            const options = Array.from(nameSelect.options).map(option => {
                const name = option.value;
                const metadata = filterEmployeeMetadata[name];

                if (!metadata) return {
                    value: name,
                    text: name,
                    selected: selectedNames.includes(name)
                };

                const indicators = [];
                let autoSelected = false;

                // Check if affected by manager filter
                if (excludeManagers.checked && metadata.isManager) {
                    indicators.push('manager');
                    autoSelected = true;
                }

                // Check if affected by title filter
                if (metadata.jobTitle && excludedTitles.includes(metadata.jobTitle)) {
                    indicators.push(metadata.jobTitle);
                    autoSelected = true;
                }

                // Build display text
                let displayText = name;
                if (indicators.length > 0) {
                    displayText += ` (${indicators.join(', ')})`;
                }

                return {
                    value: name,
                    text: displayText,
                    selected: autoSelected || selectedNames.includes(name)
                };
            });

            // Clear and rebuild
            nameSelect.innerHTML = '';
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.text = opt.text;
                option.selected = opt.selected;
                option.setAttribute('data-employee-name', opt.value);
                nameSelect.appendChild(option);
            });
        }

        function applyFilters() {
            const params = new URLSearchParams();

            // Manager exclusion
            const excludeManagers = document.getElementById('excludeManagers');
            if (excludeManagers && excludeManagers.checked) {
                params.set('exclude_managers', 'true');
            }

            // Title exclusion
            const titleSelect = document.getElementById('titleSelect');
            if (titleSelect) {
                const titles = Array.from(titleSelect.selectedOptions).map(o => o.value);
                if (titles.length) {
                    params.set('exclude_titles', titles.join(','));
                }
            }

            // Name exclusion
            const nameSelect = document.getElementById('nameSelect');
            if (nameSelect) {
                const names = Array.from(nameSelect.selectedOptions).map(o => o.value);
                if (names.length) {
                    params.set('exclude_names', names.join(','));
                }
            }

            // Save to sessionStorage
            sessionStorage.setItem('filters', JSON.stringify({
                exclude_managers: excludeManagers ? excludeManagers.checked : false,
                exclude_titles: titleSelect ? Array.from(titleSelect.selectedOptions).map(o => o.value) : [],
                exclude_names: nameSelect ? Array.from(nameSelect.selectedOptions).map(o => o.value) : []
            }));

            // Reload with params
            window.location.search = params.toString();
        }

        function clearFilters() {
            // Clear sessionStorage
            sessionStorage.removeItem('filters');

            // Reload without params
            window.location.href = window.location.pathname;
        }

        // Restore filters from sessionStorage on navigation
        document.addEventListener('DOMContentLoaded', function() {
            // Only restore if no URL params present (navigating from another page)
            const urlParams = new URLSearchParams(window.location.search);
            const hasUrlFilters = urlParams.has('exclude_managers') ||
                                urlParams.has('exclude_titles') ||
                                urlParams.has('exclude_names');

            if (!hasUrlFilters) {
                const savedFilters = sessionStorage.getItem('filters');
                if (savedFilters) {
                    try {
                        const filters = JSON.parse(savedFilters);

                        // Apply filters via URL
                        const params = new URLSearchParams();

                        if (filters.exclude_managers) {
                            params.set('exclude_managers', 'true');
                        }

                        if (filters.exclude_titles && filters.exclude_titles.length) {
                            params.set('exclude_titles', filters.exclude_titles.join(','));
                        }

                        if (filters.exclude_names && filters.exclude_names.length) {
                            params.set('exclude_names', filters.exclude_names.join(','));
                        }

                        // Only reload if there are filters to apply
                        if (params.toString()) {
                            window.location.search = params.toString();
                        }
                    } catch (e) {
                        console.error('Error restoring filters:', e);
                    }
                }
            }
        });

        // Close filter panel when clicking outside
        document.addEventListener('click', function(event) {
            const panel = document.getElementById('filterPanel');
            const toggle = document.getElementById('filterToggle');

            if (panel && toggle &&
                !panel.contains(event.target) &&
                !toggle.contains(event.target) &&
                panel.classList.contains('show')) {
                panel.classList.remove('show');
            }
        });

        // Initialize filter UI listeners
        document.addEventListener('DOMContentLoaded', function() {
            const excludeManagers = document.getElementById('excludeManagers');
            const titleSelect = document.getElementById('titleSelect');

            // Listen for changes to update name dropdown indicators
            if (excludeManagers) {
                excludeManagers.addEventListener('change', updateNameDropdownIndicators);
            }

            if (titleSelect) {
                titleSelect.addEventListener('change', updateNameDropdownIndicators);
            }

            // Initial update if filter panel data exists
            if (Object.keys(filterEmployeeMetadata).length > 0) {
                updateNameDropdownIndicators();
            }
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
