{% extends "base.html" %}

{% block title %}Analytics - Quarterly Performance Rating{% endblock %}

{% block extra_css %}
<style>
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chart-container h3 {
        margin-bottom: 15px;
        color: #2c3e50;
        font-size: 18px;
    }

    canvas {
        max-height: 350px;
    }

    .ranking-table tbody tr td:first-child {
        font-weight: 600;
        color: #2c3e50;
    }

    .dept-stats, .job-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-box {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #667eea;
    }

    .stat-box h4 {
        font-size: 13px;
        color: #666;
        margin-bottom: 5px;
    }

    .stat-box .avg {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
    }

    /* Calibration styles */
    .calibration-disclaimer {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    .calibration-disclaimer h4 {
        margin: 0 0 8px 0;
        color: #2c3e50;
        font-size: 14px;
        font-weight: 600;
    }

    .calibration-disclaimer p {
        margin: 0;
        font-size: 13px;
        color: #666;
        line-height: 1.5;
    }

    .calibration-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .calibration-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #e0e0e0;
    }

    .calibration-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
    }

    .calibration-table tr:hover {
        background: #f8f9fa;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-badge.good {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.warning {
        background: #fff3cd;
        color: #856404;
    }

    .status-badge.alert {
        background: #f8d7da;
        color: #721c24;
    }

    .delta-value {
        font-weight: 600;
    }

    .delta-value.positive {
        color: #dc3545;
    }

    .delta-value.negative {
        color: #0066cc;
    }

    .small-team-warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 12px 16px;
        margin-bottom: 15px;
        border-radius: 4px;
        font-size: 13px;
        color: #856404;
    }

    .calibration-chart-container {
        height: 300px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Performance Distribution</h2>
    <div class="charts-grid">
        <div class="chart-container">
            <h3>Rating Distribution</h3>
            <canvas id="ratingChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Average by Supervisory Organization</h3>
            <canvas id="departmentChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Average by Job Profile</h3>
            <canvas id="jobChart"></canvas>
        </div>
    </div>
</div>

<!-- Distribution Calibration Section -->
{% if total_rated > 0 %}
<div class="card">
    <h2>Distribution Calibration Guide</h2>

    <div class="calibration-disclaimer">
        <h4>ℹ️ This is guidance, not a requirement</h4>
        <p>
            The suggested distribution below represents a typical performance curve for reference only.
            <strong>This is not a quota or forced ranking.</strong> Your team's actual performance may legitimately differ.
            Use this as a calibration tool to ensure your standards are appropriately set.
        </p>
    </div>

    {% if total_rated < 10 %}
    <div class="small-team-warning">
        ⚠️ <strong>Small team size ({{ total_rated }} rated):</strong> Percentage-based distributions are less meaningful for small teams.
        Focus on individual performance rather than fitting a curve.
    </div>
    {% endif %}

    <div class="calibration-chart-container">
        <canvas id="calibrationChart"></canvas>
    </div>

    <div style="overflow-x: auto;">
        <table class="calibration-table">
            <thead>
                <tr>
                    <th>Performance Band</th>
                    <th>Your Team</th>
                    <th>Suggested Range</th>
                    <th>Delta</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in calibration_data %}
                <tr>
                    <td>
                        <strong>
                            {% if item.bucket == 'above_120' %}
                                Above 120%
                            {% elif item.bucket == '90_to_120' %}
                                90-120%
                            {% elif item.bucket == '60_to_90' %}
                                60-90%
                            {% else %}
                                Below 60%
                            {% endif %}
                        </strong>
                        <br>
                        <span style="font-size: 12px; color: #666;">
                            {% if item.bucket == 'above_120' %}
                                Exceptional performers
                            {% elif item.bucket == '90_to_120' %}
                                Solid performers
                            {% elif item.bucket == '60_to_90' %}
                                Needs improvement
                            {% else %}
                                Significant concerns
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        <strong>{{ item.percentage }}%</strong>
                        <span style="color: #666; font-size: 13px;">({{ item.count }} people)</span>
                    </td>
                    <td>
                        {{ item.suggested_min }}-{{ item.suggested_max }}%
                    </td>
                    <td>
                        <span class="delta-value {{ 'positive' if item.delta > 0 else 'negative' if item.delta < 0 else '' }}">
                            {% if item.delta > 0 %}+{% endif %}{{ "%.1f"|format(item.delta) }}%
                        </span>
                    </td>
                    <td>
                        <span class="status-badge {{ item.status }}">
                            {% if item.status == 'good' %}
                                ✓ Within Range
                            {% elif item.status == 'warning' %}
                                ⚠ Slightly Off
                            {% else %}
                                ⚠️ Off Target
                            {% endif %}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<div class="card">
    <h2>Team Rankings (by Performance Rating)</h2>
    <div style="overflow-x: auto;">
        <table class="ranking-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Job Profile</th>
                    <th>Performance Rating %</th>
                    <th>Justification</th>
                </tr>
            </thead>
            <tbody>
                {% for employee in team %}
                    {% if employee.performance_rating_percent %}
                    <tr>
                        <td><strong>{{ employee.Associate }}</strong></td>
                        <td>{{ employee['Current Job Profile'] }}</td>
                        <td>
                            <span style="color: #27ae60; font-weight: 600; font-size: 16px;">
                                {{ employee.performance_rating_percent }}%
                            </span>
                        </td>
                        <td style="max-width: 400px; font-size: 13px;">
                            {{ employee.justification[:200] }}{% if employee.justification|length > 200 %}...{% endif %}
                        </td>
                    </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if tenets_summary %}
<div class="card">
    <h2>Team Tenets Analysis</h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div class="stat-box">
            <h4>Employees Evaluated</h4>
            <div class="avg">{{ employees_with_tenets }} / {{ total_employees }}</div>
        </div>
        <div class="stat-box">
            <h4>Completion Rate</h4>
            <div class="avg">{{ "%.0f"|format((employees_with_tenets / total_employees * 100) if total_employees > 0 else 0) }}%</div>
        </div>
    </div>

    <div id="tenetsChartContainer"></div>
</div>
{% endif %}

{% if org_tenets_summary and org_tenets_summary|length > 1 %}
<div class="card">
    <h2>Team Tenets Analysis by Organization</h2>

    {% for org, org_data in org_tenets_summary.items() %}
    {% if org_data.tenets|length > 0 %}
    <div style="margin-bottom: 30px;">
        <h3 style="color: #667eea; font-size: 16px; margin-bottom: 10px; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px;">
            {{ org }}
            <span style="font-size: 13px; color: #666; font-weight: normal;">
                ({{ org_data.employees_with_tenets }} {% if org_data.employees_with_tenets == 1 %}employee{% else %}employees{% endif %} evaluated)
            </span>
        </h3>
        <div id="orgTenetsChartContainer-{{ loop.index0 }}"></div>
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const chartData = {{ chart_data | tojson }};

// Rating Distribution Chart
const ratingCtx = document.getElementById('ratingChart').getContext('2d');
new Chart(ratingCtx, {
    type: 'bar',
    data: {
        labels: chartData.rating_distribution.labels,
        datasets: [{
            label: 'Number of Employees',
            data: chartData.rating_distribution.data,
            backgroundColor: [
                '#e74c3c',
                '#e67e22',
                '#f39c12',
                '#3498db',
                '#27ae60'
            ],
            borderColor: '#fff',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Employees: ' + context.parsed.y;
                    }
                }
            }
        }
    }
});

// Department Averages Chart
const deptCtx = document.getElementById('departmentChart').getContext('2d');
new Chart(deptCtx, {
    type: 'bar',
    data: {
        labels: chartData.department_averages.labels,
        datasets: [{
            label: 'Average Rating %',
            data: chartData.department_averages.data,
            backgroundColor: '#667eea',
            borderColor: '#5568d3',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        indexAxis: 'y',
        scales: {
            x: {
                beginAtZero: true,
                max: 150,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Average: ' + context.parsed.x.toFixed(1) + '%';
                    }
                }
            }
        }
    }
});

// Job Profile Averages Chart
const jobCtx = document.getElementById('jobChart').getContext('2d');
new Chart(jobCtx, {
    type: 'bar',
    data: {
        labels: chartData.job_averages.labels,
        datasets: [{
            label: 'Average Rating %',
            data: chartData.job_averages.data,
            backgroundColor: '#3498db',
            borderColor: '#2980b9',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 150,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Average: ' + context.parsed.y.toFixed(1) + '%';
                    }
                }
            }
        }
    }
});

// Calibration Chart - Overlay comparison
{% if total_rated > 0 %}
const calibrationData = {{ calibration_data | tojson }};

const calibrationCtx = document.getElementById('calibrationChart').getContext('2d');
new Chart(calibrationCtx, {
    type: 'bar',
    data: {
        labels: ['Above 120%', '90-120%', '60-90%', 'Below 60%'],
        datasets: [
            {
                label: 'Your Team',
                data: calibrationData.map(d => d.percentage),
                backgroundColor: calibrationData.map(d => {
                    if (d.status === 'good') return 'rgba(39, 174, 96, 0.7)';
                    if (d.status === 'warning') return 'rgba(255, 193, 7, 0.7)';
                    return 'rgba(220, 53, 69, 0.7)';
                }),
                borderColor: calibrationData.map(d => {
                    if (d.status === 'good') return '#27ae60';
                    if (d.status === 'warning') return '#ffc107';
                    return '#dc3545';
                }),
                borderWidth: 2
            },
            {
                label: 'Suggested Min',
                data: calibrationData.map(d => d.suggested_min),
                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                borderColor: '#667eea',
                borderWidth: 2,
                borderDash: [5, 5],
                type: 'line',
                pointRadius: 0
            },
            {
                label: 'Suggested Max',
                data: calibrationData.map(d => d.suggested_max),
                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                borderColor: '#667eea',
                borderWidth: 2,
                borderDash: [5, 5],
                type: 'line',
                pointRadius: 0,
                fill: '-1'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                },
                title: {
                    display: true,
                    text: 'Percentage of Team'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Performance Band'
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        if (context.dataset.label === 'Your Team') {
                            const item = calibrationData[context.dataIndex];
                            return `Your Team: ${item.percentage}% (${item.count} people)`;
                        }
                        return context.dataset.label + ': ' + context.parsed.y + '%';
                    }
                }
            },
            title: {
                display: true,
                text: 'Your Team Distribution vs. Suggested Range',
                font: {
                    size: 16,
                    weight: 'bold'
                }
            }
        }
    }
});
{% endif %}

// Team Tenets Diverging Bar Chart (Butterfly Chart) - Individual row per tenet
{% if tenets_summary %}
const tenetsData = {{ tenets_summary | tojson }};

// Sort by net score (strengths - weaknesses) descending
const sortedTenets = tenetsData.sort((a, b) => {
    const netScoreA = a.strength_count - a.improvement_count;
    const netScoreB = b.strength_count - b.improvement_count;
    return netScoreB - netScoreA;
});

// Find the maximum value for consistent scaling
const maxValue = Math.max(
    ...sortedTenets.map(t => Math.max(t.strength_count, t.improvement_count))
);

const container = document.getElementById('tenetsChartContainer');

// Create a row for each tenet
sortedTenets.forEach((tenet, index) => {
    // Create row div
    const row = document.createElement('div');
    row.style.cssText = 'display: grid; grid-template-columns: 1fr 300px 1fr; gap: 8px; align-items: center; margin-bottom: 4px; padding: 2px 0;';

    // Left side - Weakness bar (red, grows left)
    const weaknessDiv = document.createElement('div');
    weaknessDiv.style.cssText = 'text-align: right;';
    const weaknessCanvas = document.createElement('canvas');
    weaknessCanvas.id = `weakness-${index}`;
    weaknessCanvas.height = 25;
    weaknessDiv.appendChild(weaknessCanvas);

    // Center - Tenet name
    const labelDiv = document.createElement('div');
    labelDiv.style.cssText = 'font-weight: 600; color: #2c3e50; padding: 0 10px; text-align: center; overflow: hidden; text-overflow: ellipsis; font-size: 14px;';
    labelDiv.textContent = tenet.name;

    // Right side - Strength bar (green, grows right)
    const strengthDiv = document.createElement('div');
    strengthDiv.style.cssText = 'text-align: left;';
    const strengthCanvas = document.createElement('canvas');
    strengthCanvas.id = `strength-${index}`;
    strengthCanvas.height = 25;
    strengthDiv.appendChild(strengthCanvas);

    row.appendChild(weaknessDiv);
    row.appendChild(labelDiv);
    row.appendChild(strengthDiv);
    container.appendChild(row);

    // Create weakness chart (red, reversed)
    new Chart(weaknessCanvas.getContext('2d'), {
        type: 'bar',
        data: {
            labels: [''],
            datasets: [{
                data: [tenet.improvement_count],
                backgroundColor: '#dc3545',
                borderColor: '#c82333',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Weaknesses: ' + context.parsed.x;
                        }
                    }
                }
            },
            scales: {
                x: {
                    min: 0,
                    max: maxValue,
                    reverse: true,
                    display: false,
                    grid: { display: false },
                    ticks: { display: false }
                },
                y: {
                    display: false,
                    grid: { display: false }
                }
            }
        }
    });

    // Create strength chart (green, normal)
    new Chart(strengthCanvas.getContext('2d'), {
        type: 'bar',
        data: {
            labels: [''],
            datasets: [{
                data: [tenet.strength_count],
                backgroundColor: '#27ae60',
                borderColor: '#229954',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Strengths: ' + context.parsed.x;
                        }
                    }
                }
            },
            scales: {
                x: {
                    min: 0,
                    max: maxValue,
                    display: false,
                    grid: { display: false },
                    ticks: { display: false }
                },
                y: {
                    display: false,
                    grid: { display: false }
                }
            }
        }
    });
});

// Add legend at the top
const legendDiv = document.createElement('div');
legendDiv.style.cssText = 'display: flex; justify-content: center; gap: 30px; margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;';
legendDiv.innerHTML = `
    <div style="display: flex; align-items: center; gap: 8px;">
        <div style="width: 16px; height: 16px; background: #dc3545; border: 1px solid #c82333; border-radius: 3px;"></div>
        <span style="font-weight: 600; color: #2c3e50; font-size: 14px;">Weaknesses (Left)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
        <div style="width: 16px; height: 16px; background: #27ae60; border: 1px solid #229954; border-radius: 3px;"></div>
        <span style="font-weight: 600; color: #2c3e50; font-size: 14px;">Strengths (Right)</span>
    </div>
`;
container.insertBefore(legendDiv, container.firstChild);
{% endif %}

// Team Tenets by Organization - Individual diverging bar charts
{% if org_tenets_summary and org_tenets_summary|length > 1 %}
const orgTenetsData = {{ org_tenets_summary | tojson }};

let orgIndex = 0;
for (const [orgName, orgData] of Object.entries(orgTenetsData)) {
    if (!orgData.tenets || orgData.tenets.length === 0) {
        orgIndex++;
        continue;
    }

    const orgContainer = document.getElementById(`orgTenetsChartContainer-${orgIndex}`);

    // Sort already done on backend by net score
    const sortedOrgTenets = orgData.tenets;

    // Find the maximum value for consistent scaling within this org
    const orgMaxValue = Math.max(
        ...sortedOrgTenets.map(t => Math.max(t.strength_count, t.improvement_count)),
        1 // Minimum 1 to avoid division by zero
    );

    // Create a row for each tenet in this org
    sortedOrgTenets.forEach((tenet, tenetIndex) => {
        // Create row div
        const row = document.createElement('div');
        row.style.cssText = 'display: grid; grid-template-columns: 1fr 300px 1fr; gap: 8px; align-items: center; margin-bottom: 4px; padding: 2px 0;';

        // Left side - Weakness bar (red, grows left)
        const weaknessDiv = document.createElement('div');
        weaknessDiv.style.cssText = 'text-align: right;';
        const weaknessCanvas = document.createElement('canvas');
        weaknessCanvas.id = `org${orgIndex}-weakness-${tenetIndex}`;
        weaknessCanvas.height = 25;
        weaknessDiv.appendChild(weaknessCanvas);

        // Center - Tenet name
        const labelDiv = document.createElement('div');
        labelDiv.style.cssText = 'font-weight: 600; color: #2c3e50; padding: 0 10px; text-align: center; overflow: hidden; text-overflow: ellipsis; font-size: 14px;';
        labelDiv.textContent = tenet.name;

        // Right side - Strength bar (green, grows right)
        const strengthDiv = document.createElement('div');
        strengthDiv.style.cssText = 'text-align: left;';
        const strengthCanvas = document.createElement('canvas');
        strengthCanvas.id = `org${orgIndex}-strength-${tenetIndex}`;
        strengthCanvas.height = 25;
        strengthDiv.appendChild(strengthCanvas);

        row.appendChild(weaknessDiv);
        row.appendChild(labelDiv);
        row.appendChild(strengthDiv);
        orgContainer.appendChild(row);

        // Create weakness chart (red, reversed)
        new Chart(weaknessCanvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [''],
                datasets: [{
                    data: [tenet.improvement_count],
                    backgroundColor: '#dc3545',
                    borderColor: '#c82333',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Weaknesses: ' + context.parsed.x;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        min: 0,
                        max: orgMaxValue,
                        reverse: true,
                        display: false,
                        grid: { display: false },
                        ticks: { display: false }
                    },
                    y: {
                        display: false,
                        grid: { display: false }
                    }
                }
            }
        });

        // Create strength chart (green, normal)
        new Chart(strengthCanvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: [''],
                datasets: [{
                    data: [tenet.strength_count],
                    backgroundColor: '#27ae60',
                    borderColor: '#229954',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Strengths: ' + context.parsed.x;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        min: 0,
                        max: orgMaxValue,
                        display: false,
                        grid: { display: false },
                        ticks: { display: false }
                    },
                    y: {
                        display: false,
                        grid: { display: false }
                    }
                }
            }
        });
    });

    // Add legend at the top of this org's chart (only for first org to avoid repetition)
    if (orgIndex === 0) {
        const orgLegendDiv = document.createElement('div');
        orgLegendDiv.style.cssText = 'display: flex; justify-content: center; gap: 30px; margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;';
        orgLegendDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 16px; height: 16px; background: #dc3545; border: 1px solid #c82333; border-radius: 3px;"></div>
                <span style="font-weight: 600; color: #2c3e50; font-size: 14px;">Weaknesses (Left)</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 16px; height: 16px; background: #27ae60; border: 1px solid #229954; border-radius: 3px;"></div>
                <span style="font-weight: 600; color: #2c3e50; font-size: 14px;">Strengths (Right)</span>
            </div>
        `;
        orgContainer.insertBefore(orgLegendDiv, orgContainer.firstChild);
    }

    orgIndex++;
}
{% endif %}
</script>
{% endblock %}
