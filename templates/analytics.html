{% extends "base.html" %}

{% block title %}Analytics - Performance Rating{% endblock %}

{% block extra_css %}
<style>
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chart-container h3 {
        margin-bottom: 15px;
        color: #2c3e50;
        font-size: 18px;
    }

    canvas {
        max-height: 350px;
    }

    .ranking-table tbody tr td:first-child {
        font-weight: 600;
        color: #2c3e50;
    }

    .dept-stats, .job-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-box {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #667eea;
    }

    .stat-box h4 {
        font-size: 13px;
        color: #666;
        margin-bottom: 5px;
    }

    .stat-box .avg {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
    }

    /* Calibration styles */
    .calibration-disclaimer {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    .calibration-disclaimer h4 {
        margin: 0 0 8px 0;
        color: #2c3e50;
        font-size: 14px;
        font-weight: 600;
    }

    .calibration-disclaimer p {
        margin: 0;
        font-size: 13px;
        color: #666;
        line-height: 1.5;
    }

    .calibration-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .calibration-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #e0e0e0;
    }

    .calibration-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
    }

    .calibration-table tr:hover {
        background: #f8f9fa;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-badge.good {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.warning {
        background: #fff3cd;
        color: #856404;
    }

    .status-badge.alert {
        background: #f8d7da;
        color: #721c24;
    }

    .delta-value {
        font-weight: 600;
        font-size: 14px;
    }

    .delta-value.delta-good {
        color: #155724;
    }

    .delta-value.delta-warning {
        color: #856404;
    }

    .delta-value.delta-alert {
        color: #721c24;
    }

    .small-team-warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 12px 16px;
        margin-bottom: 15px;
        border-radius: 4px;
        font-size: 13px;
        color: #856404;
    }

    .calibration-chart-container {
        height: 300px;
        margin-bottom: 20px;
    }

    /* Sortable table headers */
    th.sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 25px;
    }

    th.sortable:hover {
        background: #e8e9ea;
    }

    th.sortable::after {
        content: '‚áÖ';
        position: absolute;
        right: 8px;
        opacity: 0.3;
        font-size: 12px;
    }

    th.sortable.asc::after {
        content: '‚Üë';
        opacity: 1;
    }

    th.sortable.desc::after {
        content: '‚Üì';
        opacity: 1;
    }

    /* Tab styles */
    .tabs {
        display: flex;
        gap: 5px;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 0;
    }

    .tab-button {
        padding: 12px 24px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        color: #666;
        transition: all 0.2s;
    }

    .tab-button:hover {
        color: #667eea;
        background: rgba(102, 126, 234, 0.05);
    }

    .tab-button.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<!-- 1. Performance Distribution -->
<div class="card">
    <h2>Performance Distribution</h2>
    <div class="charts-grid">
        <div class="chart-container">
            <h3>Rating Distribution</h3>
            <canvas id="ratingChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Average by Supervisory Organization</h3>
            <canvas id="departmentChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Average by Job Profile</h3>
            <canvas id="jobChart"></canvas>
        </div>
    </div>
</div>

<!-- 2. Team Tenets Analysis -->
{% if tenets_summary %}
<div class="card">
    <h2>Team Tenets Analysis</h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div class="stat-box">
            <h4>Employees Evaluated</h4>
            <div class="avg">{{ employees_with_tenets }} / {{ total_employees }}</div>
        </div>
        <div class="stat-box">
            <h4>Completion Rate</h4>
            <div class="avg">{{ "%.0f"|format((employees_with_tenets / total_employees * 100) if total_employees > 0 else 0) }}%</div>
        </div>
    </div>

    <div id="tenetsChartContainer"></div>
</div>
{% endif %}

<!-- 3. Distribution Calibration Guide -->
{% if total_rated > 0 %}
<div class="card">
    <h2>Distribution Calibration Guide</h2>

    <!-- Tab Navigation (only if multi-team) -->
    {% if is_multi_team %}
    <div class="tabs" style="margin-bottom: 20px;">
        <button class="tab-button active" data-tab="org-calibration">Organization Overview</button>
        <button class="tab-button" data-tab="team-calibrations">Per-Team Calibration</button>
        <button class="tab-button" data-tab="team-comparison">Team Comparison</button>
    </div>
    {% endif %}

    <!-- Tab 1: Organization Overview (current view) -->
    <div class="tab-content {% if not is_multi_team or true %}active{% endif %}" id="org-calibration">

    <div class="calibration-disclaimer">
        <h4>‚ÑπÔ∏è This is guidance, not a requirement</h4>
        <p>
            The suggested distribution below represents a typical performance curve for reference only.
            <strong>This is not a quota or forced ranking.</strong> Your team's actual performance may legitimately differ.
            Use this as a calibration tool to ensure your standards are appropriately set.
        </p>
    </div>

    {% if total_rated < 10 %}
    <div class="small-team-warning">
        ‚ö†Ô∏è <strong>Small team size ({{ total_rated }} rated):</strong> Percentage-based distributions are less meaningful for small teams.
        Focus on individual performance rather than fitting a curve.
    </div>
    {% endif %}

    <div class="calibration-chart-container">
        <canvas id="calibrationChart"></canvas>
    </div>

    <div style="overflow-x: auto;">
        <table class="calibration-table">
            <thead>
                <tr>
                    <th>Performance Band</th>
                    <th>Your Team</th>
                    <th>Suggested Range</th>
                    <th>Delta</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in calibration_data %}
                <tr>
                    <td>
                        <strong>
                            {% if item.bucket == 'above_120' %}
                                Above 120%
                            {% elif item.bucket == '90_to_120' %}
                                90-120%
                            {% elif item.bucket == '60_to_90' %}
                                60-90%
                            {% else %}
                                Below 60%
                            {% endif %}
                        </strong>
                        <br>
                        <span style="font-size: 12px; color: #666;">
                            {% if item.bucket == 'above_120' %}
                                Exceptional performers
                            {% elif item.bucket == '90_to_120' %}
                                Solid performers
                            {% elif item.bucket == '60_to_90' %}
                                Needs improvement
                            {% else %}
                                Significant concerns
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        <strong>{{ item.percentage }}%</strong>
                        <span style="color: #666; font-size: 13px;">({{ item.count }} people)</span>
                    </td>
                    <td>
                        {{ item.suggested_min }}-{{ item.suggested_max }}%
                        <span style="color: #666; font-size: 13px;">({{ item.suggested_min_people }}-{{ item.suggested_max_people }} people)</span>
                    </td>
                    <td>
                        <span class="delta-value delta-{{ item.status }}">
                            {% if item.delta > 0 %}+{% endif %}{{ "%.1f"|format(item.delta) }}%
                        </span>
                    </td>
                    <td>
                        <span class="status-badge {{ item.status }}">
                            {% if item.status == 'good' %}
                                ‚úì Within Range
                            {% elif item.status == 'warning' %}
                                ‚ö† Slightly Off
                            {% else %}
                                ‚ö†Ô∏è Off Target
                            {% endif %}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    </div>
    <!-- End Tab 1: Organization Overview -->

    <!-- Tab 2: Per-Team Calibration -->
    {% if is_multi_team %}
    <div class="tab-content" id="team-calibrations">
        <div class="calibration-disclaimer">
            <h4>‚ÑπÔ∏è Per-Team Distribution Analysis</h4>
            <p>
                Each team's calibration is calculated independently. This helps identify teams with potential
                rating inflation, deflation, or inconsistent standards compared to the organization-wide distribution.
            </p>
        </div>

        {% for team_cal in team_calibrations %}
        <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <h3 style="margin-top: 0;">{{ team_cal.team_name }}</h3>
            <p style="color: #666; margin-bottom: 15px;">{{ team_cal.total_rated }} employees rated</p>

            {% if team_cal.total_rated < 10 %}
            <div class="small-team-warning" style="margin-bottom: 15px;">
                ‚ö†Ô∏è <strong>Small team size:</strong> Percentage-based distributions are less meaningful for small teams.
                Focus on individual performance rather than fitting a curve.
            </div>
            {% endif %}

            <div style="overflow-x: auto;">
                <table class="calibration-table">
                    <thead>
                        <tr>
                            <th>Performance Band</th>
                            <th>This Team</th>
                            <th>Suggested Range</th>
                            <th>Delta</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in team_cal.data %}
                        <tr>
                            <td>
                                <strong>
                                    {% if item.bucket == 'above_120' %}
                                        Above 120%
                                    {% elif item.bucket == '90_to_120' %}
                                        90-120%
                                    {% elif item.bucket == '60_to_90' %}
                                        60-90%
                                    {% else %}
                                        Below 60%
                                    {% endif %}
                                </strong>
                                <br>
                                <span style="font-size: 12px; color: #666;">
                                    {% if item.bucket == 'above_120' %}
                                        Exceptional performers
                                    {% elif item.bucket == '90_to_120' %}
                                        Solid performers
                                    {% elif item.bucket == '60_to_90' %}
                                        Needs improvement
                                    {% else %}
                                        Significant concerns
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                <strong>{{ item.percentage }}%</strong>
                                <span style="color: #666; font-size: 13px;">({{ item.count }} people)</span>
                            </td>
                            <td>
                                {{ item.suggested_min }}-{{ item.suggested_max }}%
                                <span style="color: #666; font-size: 13px;">({{ item.suggested_min_people }}-{{ item.suggested_max_people }} people)</span>
                            </td>
                            <td>
                                <span class="delta-value delta-{{ item.status }}">
                                    {% if item.delta > 0 %}+{% endif %}{{ "%.1f"|format(item.delta) }}%
                                </span>
                            </td>
                            <td>
                                <span class="status-badge {{ item.status }}">
                                    {% if item.status == 'good' %}
                                        ‚úì Within Range
                                    {% elif item.status == 'warning' %}
                                        ‚ö† Slightly Off
                                    {% else %}
                                        ‚ö†Ô∏è Off Target
                                    {% endif %}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <!-- End Tab 2: Per-Team Calibration -->

    <!-- Tab 3: Team Comparison Matrix -->
    {% if is_multi_team %}
    <div class="tab-content" id="team-comparison">
        <div class="calibration-disclaimer">
            <h4>‚ÑπÔ∏è Cross-Team Calibration Comparison</h4>
            <p>
                Compare calibration distributions across all teams to identify potential inconsistencies in
                rating standards. Teams significantly outside suggested ranges may benefit from calibration discussions.
            </p>
        </div>

        <div style="overflow-x: auto;">
            <table class="calibration-table">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Size</th>
                        <th>Avg Rating</th>
                        <th>Std Dev</th>
                        <th>Above 120%</th>
                        <th>90-120%</th>
                        <th>60-90%</th>
                        <th>Below 60%</th>
                        <th>Calibration Health</th>
                    </tr>
                </thead>
                <tbody>
                    {% for team in team_comparisons %}
                    <tr>
                        <td><strong>{{ team.team_name }}</strong></td>
                        <td>{{ team.size }}</td>
                        <td>{{ team.avg_rating }}%</td>
                        <td>{{ team.std_dev }}%</td>
                        {% for bucket in ['above_120', '90_to_120', '60_to_90', 'below_60'] %}
                        <td style="{% if team.buckets[bucket].status != 'good' %}background: #fff3cd;{% endif %}">
                            {{ team.buckets[bucket].percentage }}%
                            {% if team.buckets[bucket].status != 'good' %}
                            <span style="color: #856404;">‚ö†</span>
                            {% else %}
                            <span style="color: #155724;">‚úì</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td>
                            <span class="status-badge {{ team.calibration_health }}">
                                {% if team.calibration_health == 'good' %}
                                    ‚úì Good
                                {% elif team.calibration_health == 'warning' %}
                                    ‚ö† Review
                                {% else %}
                                    ‚ö†Ô∏è Issues
                                {% endif %}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Calibration Insights -->
        <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
            <h4 style="margin: 0 0 10px 0; color: #1976D2;">üìä Calibration Insights</h4>
            <ul style="margin: 0; padding-left: 20px; color: #555;">
                {% set max_avg = team_comparisons | map(attribute='avg_rating') | max %}
                {% set min_avg = team_comparisons | map(attribute='avg_rating') | min %}
                {% set avg_spread = max_avg - min_avg %}

                {% if avg_spread > 30 %}
                <li><strong>Large rating variance:</strong> {{ "%.1f"|format(avg_spread) }}% spread between highest ({{ "%.1f"|format(max_avg) }}%) and lowest ({{ "%.1f"|format(min_avg) }}%) average teams. Consider calibration discussion.</li>
                {% elif avg_spread > 20 %}
                <li><strong>Moderate rating variance:</strong> {{ "%.1f"|format(avg_spread) }}% spread across teams. Monitor for consistency.</li>
                {% else %}
                <li><strong>Consistent ratings:</strong> Teams show similar average ratings ({{ "%.1f"|format(avg_spread) }}% spread). Well-calibrated organization.</li>
                {% endif %}

                {% set high_variance_teams = team_comparisons | selectattr('std_dev', '>', 20) | list %}
                {% if high_variance_teams | length > 0 %}
                <li><strong>High variance within teams:</strong> {{ high_variance_teams | map(attribute='team_name') | join(', ') }} show high standard deviation (>20%). Wide range of performance levels.</li>
                {% endif %}

                {% set problematic_teams = team_comparisons | selectattr('calibration_health', 'equalto', 'alert') | list %}
                {% if problematic_teams | length > 0 %}
                <li><strong>Calibration attention needed:</strong> {{ problematic_teams | map(attribute='team_name') | join(', ') }} have multiple buckets outside suggested ranges.</li>
                {% endif %}

                {% set good_teams = team_comparisons | selectattr('calibration_health', 'equalto', 'good') | list %}
                {% if good_teams | length == team_comparisons | length %}
                <li><strong>‚úì All teams well-calibrated:</strong> Every team falls within suggested distribution ranges.</li>
                {% endif %}
            </ul>
        </div>
    </div>
    {% endif %}
    <!-- End Tab 3: Team Comparison Matrix -->

</div>
{% endif %}

<!-- 4. Team Rankings -->
<div class="card">
    <h2>Team Rankings (by Performance Rating)</h2>
    <div style="overflow-x: auto;">
        <table class="ranking-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="name">Name</th>
                    <th class="sortable" data-sort="job">Job Profile</th>
                    <th class="sortable" data-sort="rating">Performance Rating %</th>
                    <th>Justification</th>
                </tr>
            </thead>
            <tbody id="rankingsTableBody">
                {% for employee in team %}
                    {% if employee.performance_rating_percent %}
                    <tr data-name="{{ employee.Associate }}"
                        data-job="{{ employee['Current Job Profile'] }}"
                        data-rating="{{ employee.performance_rating_percent }}">
                        <td><strong><span class="employee-name" data-employee-name="{{ employee.Associate }}">{{ employee.Associate }}</span></strong></td>
                        <td>{{ employee['Current Job Profile'] }}</td>
                        <td>
                            <span style="color: #27ae60; font-weight: 600; font-size: 16px;">
                                {{ employee.performance_rating_percent }}%
                            </span>
                        </td>
                        <td style="max-width: 400px; font-size: 13px;">
                            {{ employee.justification[:200] }}{% if employee.justification|length > 200 %}...{% endif %}
                        </td>
                    </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const chartData = {{ chart_data | tojson }};

// Rating Distribution Chart
const ratingCtx = document.getElementById('ratingChart').getContext('2d');
new Chart(ratingCtx, {
    type: 'bar',
    data: {
        labels: chartData.rating_distribution.labels,
        datasets: [{
            label: 'Number of Employees',
            data: chartData.rating_distribution.data,
            backgroundColor: [
                '#e74c3c',
                '#e67e22',
                '#f39c12',
                '#3498db',
                '#27ae60'
            ],
            borderColor: '#fff',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Employees: ' + context.parsed.y;
                    }
                }
            }
        }
    }
});

// Department Averages Chart
const deptCtx = document.getElementById('departmentChart').getContext('2d');
new Chart(deptCtx, {
    type: 'bar',
    data: {
        labels: chartData.department_averages.labels,
        datasets: [{
            label: 'Average Rating %',
            data: chartData.department_averages.data,
            backgroundColor: '#667eea',
            borderColor: '#5568d3',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        indexAxis: 'y',
        scales: {
            x: {
                beginAtZero: true,
                max: 150,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Average: ' + context.parsed.x.toFixed(1) + '%';
                    }
                }
            }
        }
    }
});

// Job Profile Averages Chart
const jobCtx = document.getElementById('jobChart').getContext('2d');
new Chart(jobCtx, {
    type: 'bar',
    data: {
        labels: chartData.job_averages.labels,
        datasets: [{
            label: 'Average Rating %',
            data: chartData.job_averages.data,
            backgroundColor: '#3498db',
            borderColor: '#2980b9',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 150,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Average: ' + context.parsed.y.toFixed(1) + '%';
                    }
                }
            }
        }
    }
});

// Calibration Chart - Overlay comparison
{% if total_rated > 0 %}
const calibrationData = {{ calibration_data | tojson }};

const calibrationCtx = document.getElementById('calibrationChart').getContext('2d');
new Chart(calibrationCtx, {
    type: 'bar',
    data: {
        labels: ['Above 120%', '90-120%', '60-90%', 'Below 60%'],
        datasets: [
            {
                label: 'Your Team',
                data: calibrationData.map(d => d.percentage),
                backgroundColor: calibrationData.map(d => {
                    if (d.status === 'good') return 'rgba(39, 174, 96, 0.7)';
                    if (d.status === 'warning') return 'rgba(255, 193, 7, 0.7)';
                    return 'rgba(220, 53, 69, 0.7)';
                }),
                borderColor: calibrationData.map(d => {
                    if (d.status === 'good') return '#27ae60';
                    if (d.status === 'warning') return '#ffc107';
                    return '#dc3545';
                }),
                borderWidth: 2
            },
            {
                label: 'Suggested Min',
                data: calibrationData.map(d => d.suggested_min),
                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                borderColor: '#667eea',
                borderWidth: 2,
                borderDash: [5, 5],
                type: 'line',
                pointRadius: 0
            },
            {
                label: 'Suggested Max',
                data: calibrationData.map(d => d.suggested_max),
                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                borderColor: '#667eea',
                borderWidth: 2,
                borderDash: [5, 5],
                type: 'line',
                pointRadius: 0,
                fill: '-1'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                },
                title: {
                    display: true,
                    text: 'Percentage of Team'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Performance Band'
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        if (context.dataset.label === 'Your Team') {
                            const item = calibrationData[context.dataIndex];
                            return `Your Team: ${item.percentage}% (${item.count} people)`;
                        }
                        return context.dataset.label + ': ' + context.parsed.y + '%';
                    }
                }
            },
            title: {
                display: true,
                text: 'Your Team Distribution vs. Suggested Range',
                font: {
                    size: 16,
                    weight: 'bold'
                }
            }
        }
    }
});
{% endif %}

// Team Tenets Diverging Bar Chart (Butterfly Chart) - Individual row per tenet
{% if tenets_summary %}
const tenetsData = {{ tenets_summary | tojson }};

// Sort by net score (strengths - weaknesses) descending
const sortedTenets = tenetsData.sort((a, b) => {
    const netScoreA = a.strength_count - a.improvement_count;
    const netScoreB = b.strength_count - b.improvement_count;
    return netScoreB - netScoreA;
});

// Find the maximum value for consistent scaling
const maxValue = Math.max(
    ...sortedTenets.map(t => Math.max(t.strength_count, t.improvement_count))
);

const container = document.getElementById('tenetsChartContainer');

// Create a row for each tenet
sortedTenets.forEach((tenet, index) => {
    // Create row div
    const row = document.createElement('div');
    row.style.cssText = 'display: grid; grid-template-columns: 1fr 300px 1fr; gap: 8px; align-items: center; margin-bottom: 4px; padding: 2px 0;';

    // Left side - Weakness bar (red, grows left)
    const weaknessDiv = document.createElement('div');
    weaknessDiv.style.cssText = 'text-align: right;';
    const weaknessCanvas = document.createElement('canvas');
    weaknessCanvas.id = `weakness-${index}`;
    weaknessCanvas.height = 25;
    weaknessDiv.appendChild(weaknessCanvas);

    // Center - Tenet name
    const labelDiv = document.createElement('div');
    labelDiv.style.cssText = 'font-weight: 600; color: #2c3e50; padding: 0 10px; text-align: center; overflow: hidden; text-overflow: ellipsis; font-size: 14px;';
    labelDiv.textContent = tenet.name;

    // Right side - Strength bar (green, grows right)
    const strengthDiv = document.createElement('div');
    strengthDiv.style.cssText = 'text-align: left;';
    const strengthCanvas = document.createElement('canvas');
    strengthCanvas.id = `strength-${index}`;
    strengthCanvas.height = 25;
    strengthDiv.appendChild(strengthCanvas);

    row.appendChild(weaknessDiv);
    row.appendChild(labelDiv);
    row.appendChild(strengthDiv);
    container.appendChild(row);

    // Create weakness chart (red, reversed)
    new Chart(weaknessCanvas.getContext('2d'), {
        type: 'bar',
        data: {
            labels: [''],
            datasets: [{
                data: [tenet.improvement_count],
                backgroundColor: '#dc3545',
                borderColor: '#c82333',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Weaknesses: ' + context.parsed.x;
                        }
                    }
                }
            },
            scales: {
                x: {
                    min: 0,
                    max: maxValue,
                    reverse: true,
                    display: false,
                    grid: { display: false },
                    ticks: { display: false }
                },
                y: {
                    display: false,
                    grid: { display: false }
                }
            }
        }
    });

    // Create strength chart (green, normal)
    new Chart(strengthCanvas.getContext('2d'), {
        type: 'bar',
        data: {
            labels: [''],
            datasets: [{
                data: [tenet.strength_count],
                backgroundColor: '#27ae60',
                borderColor: '#229954',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Strengths: ' + context.parsed.x;
                        }
                    }
                }
            },
            scales: {
                x: {
                    min: 0,
                    max: maxValue,
                    display: false,
                    grid: { display: false },
                    ticks: { display: false }
                },
                y: {
                    display: false,
                    grid: { display: false }
                }
            }
        }
    });
});

// Add legend at the top
const legendDiv = document.createElement('div');
legendDiv.style.cssText = 'display: flex; justify-content: center; gap: 30px; margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px;';
legendDiv.innerHTML = `
    <div style="display: flex; align-items: center; gap: 8px;">
        <div style="width: 16px; height: 16px; background: #dc3545; border: 1px solid #c82333; border-radius: 3px;"></div>
        <span style="font-weight: 600; color: #2c3e50; font-size: 14px;">Weaknesses (Left)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
        <div style="width: 16px; height: 16px; background: #27ae60; border: 1px solid #229954; border-radius: 3px;"></div>
        <span style="font-weight: 600; color: #2c3e50; font-size: 14px;">Strengths (Right)</span>
    </div>
`;
container.insertBefore(legendDiv, container.firstChild);
{% endif %}

// Table sorting for Team Rankings
document.addEventListener('DOMContentLoaded', function() {
    const headers = document.querySelectorAll('th.sortable');
    let currentSort = { column: 'rating', direction: 'desc' };

    headers.forEach(header => {
        header.addEventListener('click', function() {
            const sortKey = this.getAttribute('data-sort');
            sortRankingsTable(sortKey);
        });
    });

    function sortRankingsTable(column) {
        const tbody = document.getElementById('rankingsTableBody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        // Toggle direction if same column, otherwise default to ascending
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }

        // Update header classes
        document.querySelectorAll('th.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
        });
        document.querySelector(`th[data-sort="${column}"]`).classList.add(currentSort.direction);

        // Sort rows
        rows.sort((a, b) => {
            let aVal = a.getAttribute(`data-${column}`);
            let bVal = b.getAttribute(`data-${column}`);

            // For rating, convert to numbers
            if (column === 'rating') {
                aVal = parseFloat(aVal);
                bVal = parseFloat(bVal);
            } else {
                // For text, case-insensitive comparison
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }

            if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });

        // Re-append rows in sorted order
        rows.forEach(row => tbody.appendChild(row));
    }

    // Set initial sort indicator
    document.querySelector('th[data-sort="rating"]').classList.add('desc');

    // Tab switching for multi-team calibration views
    {% if is_multi_team %}
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');

            // Remove active class from all buttons and content
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Add active class to clicked button and corresponding content
            this.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
        });
    });
    {% endif %}
});
</script>
{% endblock %}
