{% extends "base.html" %}

{% block title %}Bonus Calculation - Performance Rating{% endblock %}

{% block extra_css %}
<style>
    .config-panel {
        background: #f8f9fa;
        border: 2px solid #667eea;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }

    .config-panel h3 {
        margin: 0 0 15px 0;
        color: #2c3e50;
        font-size: 18px;
    }

    .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .config-input {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .config-input label {
        font-size: 13px;
        font-weight: 600;
        color: #2c3e50;
    }

    .config-input input {
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .config-input input:focus {
        outline: none;
        border-color: #667eea;
    }

    .config-help {
        font-size: 12px;
        color: #666;
        margin-top: 3px;
    }

    .calculate-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
    }

    .calculate-btn:hover {
        background: #5568d3;
    }

    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .summary-card {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }

    .summary-card h4 {
        margin: 0 0 8px 0;
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
    }

    .summary-card .value {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
    }

    #budget_override_input {
        cursor: pointer;
        transition: all 0.2s;
    }

    #budget_override_input:hover {
        background: rgba(102, 126, 234, 0.05) !important;
        border-radius: 4px !important;
    }

    #budget_override_input:focus {
        outline: none;
        background: rgba(102, 126, 234, 0.1) !important;
        border: 1px solid #667eea !important;
        border-radius: 4px !important;
        padding: 2px 4px !important;
    }

    .bonus-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .bonus-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #e0e0e0;
        position: sticky;
        top: 0;
    }

    .bonus-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #f0f0f0;
    }

    .bonus-table tr:hover {
        background: #f8f9fa;
    }

    .bonus-table th.right, .bonus-table td.right {
        text-align: right;
    }

    .performance-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 600;
        font-size: 12px;
    }

    .performance-high {
        background: #d4edda;
        color: #155724;
    }

    .performance-mid {
        background: #fff3cd;
        color: #856404;
    }

    .performance-low {
        background: #f8d7da;
        color: #721c24;
    }

    .no-data-message {
        text-align: center;
        padding: 40px;
        background: #f8f9fa;
        border-radius: 8px;
        color: #666;
    }

    .methodology {
        background: #e8eaf6;
        border-left: 4px solid #667eea;
        padding: 15px 20px;
        margin-top: 20px;
        border-radius: 4px;
    }

    .methodology h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
        font-size: 14px;
    }

    .methodology ol {
        margin: 5px 0;
        padding-left: 20px;
    }

    .methodology li {
        font-size: 13px;
        color: #555;
        margin: 5px 0;
        line-height: 1.5;
    }

    .methodology code {
        background: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
    }

    /* Sortable table headers */
    th.sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 25px;
    }

    th.sortable:hover {
        background: #e8e9ea;
    }

    th.sortable::after {
        content: '‚áÖ';
        position: absolute;
        right: 8px;
        opacity: 0.5;
        font-size: 12px;
    }

    th.sortable.asc::after {
        content: '‚Üë';
        opacity: 1;
    }

    th.sortable.desc::after {
        content: '‚Üì';
        opacity: 1;
    }

    /* Tab navigation */
    .tabs {
        display: flex;
        gap: 2px;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 20px;
    }

    .tab-button {
        background: #f8f9fa;
        border: none;
        padding: 12px 24px;
        font-size: 14px;
        font-weight: 600;
        color: #666;
        cursor: pointer;
        border-radius: 6px 6px 0 0;
        transition: all 0.2s;
    }

    .tab-button:hover {
        background: #e8e9ea;
        color: #2c3e50;
    }

    .tab-button.active {
        background: white;
        color: #667eea;
        border-bottom: 2px solid #667eea;
        margin-bottom: -2px;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Team comparison table */
    .team-comparison-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        margin-top: 15px;
    }

    .team-comparison-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #e0e0e0;
    }

    .team-comparison-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
    }

    .team-comparison-table tr:hover {
        background: #f8f9fa;
    }

    .team-comparison-table .right {
        text-align: right;
    }

    .status-gain {
        color: #27ae60;
        font-weight: 600;
    }

    .status-loss {
        color: #dc3545;
        font-weight: 600;
    }

    .status-neutral {
        color: #666;
        font-weight: 600;
    }

    .comparison-intro {
        background: #e8f4f8;
        border-left: 4px solid #3498db;
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    .comparison-intro h4 {
        margin: 0 0 8px 0;
        color: #2c3e50;
        font-size: 14px;
        font-weight: 600;
    }

    .comparison-intro p {
        margin: 0;
        font-size: 13px;
        color: #555;
        line-height: 1.6;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Bonus Calculation (Phase 2)</h2>

    <!-- Tab navigation (only show if multi-team) -->
    {% if is_multi_team %}
    <div class="tabs">
        <button class="tab-button active" data-tab="overview">Overview</button>
        <button class="tab-button" data-tab="team-comparison">Team Comparison</button>
        <button class="tab-button" data-tab="detailed">Detailed Breakdown</button>
    </div>
    {% endif %}

    <div class="config-panel">
        <h3>üîß Configuration Parameters</h3>
        <form method="GET" action="{{ url_for('bonus_calculation') }}">
            <div class="config-grid">
                <div class="config-input">
                    <label for="upside_exponent">Upside Exponent</label>
                    <input type="number" step="0.01" id="upside_exponent" name="upside_exponent"
                           value="{{ params.upside_exponent }}" required>
                    <span class="config-help">Exponential reward for rating ‚â• 100% (e.g., 1.35)</span>
                </div>

                <div class="config-input">
                    <label for="downside_exponent">Downside Exponent</label>
                    <input type="number" step="0.01" id="downside_exponent" name="downside_exponent"
                           value="{{ params.downside_exponent }}" required>
                    <span class="config-help">Exponential penalty for rating < 100% (e.g., 1.9)</span>
                </div>
            </div>

            <button type="submit" class="calculate-btn">üîÑ Recalculate with New Parameters</button>
        </form>
    </div>


    <!-- Tab 1: Overview (existing view) -->
    <div class="tab-content {% if not is_multi_team or true %}active{% endif %}" id="overview">
    {% if has_data %}
    <div class="card" style="margin-bottom: 20px;">
        <h3>Performance-to-Bonus Curve (Your Team)</h3>
        <div style="height: 450px;">
            <canvas id="bonusCurveChart"></canvas>
        </div>
    </div>

    {% if employees_without_bonus_target > 0 %}
    <div class="small-team-warning" style="margin-bottom: 20px;">
        ‚ö†Ô∏è <strong>Incomplete bonus data:</strong> {{ employees_without_bonus_target }} out of {{ total_rated }} rated employees are missing bonus target information from Workday and were excluded from this calculation.
        To include all employees, ensure the Workday export contains bonus target data for everyone.
    </div>
    {% endif %}

    <div class="summary-stats">
        <div class="summary-card">
            <h4>Base Bonus Pool</h4>
            <div class="value">${{ "{:,.0f}".format(base_pool) }}</div>
        </div>
        <div class="summary-card" style="position: relative;">
            <h4 title="Additional budget in USD (can be negative). Distributes proportionally across all employees. Click to edit.">
                Budget Override
                <span style="cursor: help; opacity: 0.6;">‚ìò</span>
            </h4>
            <div class="value" style="{% if budget_override_usd > 0 %}color: #27ae60;{% elif budget_override_usd < 0 %}color: #dc3545;{% endif %}">
                $<input type="number"
                       id="budget_override_input"
                       value="{{ budget_override_usd }}"
                       style="border: none; background: transparent; color: inherit; font-size: inherit; font-weight: inherit; width: 120px; text-align: center; font-family: inherit;"
                       title="Additional budget in USD (can be negative). Auto-saves after 2 seconds.">
            </div>
            <div style="position: absolute; bottom: 5px; right: 10px; font-size: 11px; color: #27ae60; opacity: 0; transition: opacity 0.3s;" id="budget-save-indicator">
                ‚úì Saved
            </div>
        </div>
        <div class="summary-card">
            <h4>Adjusted Pool</h4>
            <div class="value">${{ "{:,.0f}".format(total_pool) }}</div>
        </div>
        <div class="summary-card">
            <h4>Total Allocated</h4>
            <div class="value">${{ "{:,.0f}".format(total_allocated) }}</div>
        </div>
        <div class="summary-card">
            <h4>Rated Employees</h4>
            <div class="value">{{ team|length }}</div>
        </div>
    </div>

    <div style="overflow-x: auto;">
        <table class="bonus-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="name">Name</th>
                    <th class="sortable" data-sort="job">Job Profile</th>
                    <th class="right sortable" data-sort="rating">Rating %</th>
                    <th class="right sortable" data-sort="target">Bonus Target</th>
                    <th class="right sortable" data-sort="perf-mult">Perf Mult</th>
                    <th class="right sortable" data-sort="final">Final Bonus</th>
                    <th class="right sortable" data-sort="percent">% of Target</th>
                </tr>
            </thead>
            <tbody>
                {% for result in team %}
                <tr data-name="{{ result.employee.Associate }}"
                    data-job="{{ result.employee['Current Job Profile'] }}"
                    data-rating="{{ result.rating }}"
                    data-target="{{ result.bonus_target_usd }}"
                    data-perf-mult="{{ result.perf_multiplier }}"
                    data-final="{{ result.final_bonus }}"
                    data-percent="{{ result.bonus_percent_of_target }}">
                    <td><strong><span class="employee-name" data-employee-id="{{ result.employee['Associate ID'] }}">{{ result.employee.Associate }}</span></strong></td>
                    <td>{{ result.employee['Current Job Profile'] }}</td>
                    <td class="right">
                        <span class="performance-badge
                            {% if result.rating >= 120 %}performance-high
                            {% elif result.rating >= 90 %}performance-mid
                            {% else %}performance-low{% endif %}">
                            {{ result.rating }}%
                        </span>
                    </td>
                    <td class="right">${{ "{:,.0f}".format(result.bonus_target_usd) }}</td>
                    <td class="right">{{ "%.3f"|format(result.perf_multiplier) }}</td>
                    <td class="right"><strong>${{ "{:,.0f}".format(result.final_bonus) }}</strong></td>
                    <td class="right">
                        <strong {% if result.bonus_percent_of_target > 100 %}style="color: #27ae60;"
                                {% elif result.bonus_percent_of_target < 100 %}style="color: #dc3545;"
                                {% endif %}>
                            {{ "%.0f"|format(result.bonus_percent_of_target) }}%
                        </strong>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="methodology">
        <h4>üìã Calculation Methodology</h4>
        <ol>
            <li><strong>Total Pool:</strong> Sum of all bonus targets (from Workday, USD)</li>
            <li><strong>Performance Multiplier:</strong> If rating < 100: <code>(rating/100)^{{ params.downside_exponent }}</code>, else <code>(rating/100)^{{ params.upside_exponent }}</code></li>
            <li><strong>Raw Share:</strong> <code>Bonus Target √ó Perf Multiplier</code></li>
            <li><strong>Normalization:</strong> Final bonus = <code>Raw Share √ó Value per Share</code> (where value per share ensures total = pool)</li>
        </ol>
        <p style="margin-top: 10px; font-size: 13px; color: #555;">
            üìñ For detailed explanation of the bonus algorithm, see
            <a href="https://github.com/adereis/performance-rating-and-bonus/blob/main/docs/BONUS_CALCULATION_README.md"
               target="_blank"
               style="color: #667eea; text-decoration: underline;">
                Bonus Calculation Documentation on GitHub
            </a>
        </p>
    </div>

    {% else %}
    <div class="no-data-message">
        {% if missing_bonus_data %}
        <p style="font-size: 18px; margin-bottom: 10px;">üìã Missing bonus target data</p>
        <p>Bonus calculation requires employee bonus target information from Workday.</p>
        <p style="margin-top: 15px;">To set up bonus data:</p>
        <ol style="text-align: left; display: inline-block; margin-top: 10px;">
            <li>Export your team data from Workday (save with any filename starting with <code>real-</code>, e.g., <code>real-workday-export.xlsx</code>)</li>
            <li>Run: <code>python convert_xlsx.py real-workday-export.xlsx</code> to import the data</li>
            <li>Return to this page to calculate bonuses</li>
        </ol>
        {% else %}
        <p style="font-size: 18px; margin-bottom: 10px;">üìä No rated employees yet</p>
        <p>Performance ratings must be completed before bonus calculation can be performed.</p>
        <p><a href="{{ url_for('rate_page') }}" class="btn" style="display: inline-block; margin-top: 15px;">Go to Rating Page</a></p>
        {% endif %}
    </div>
    {% endif %}
    </div><!-- End Tab 1: Overview -->

    <!-- Tab 2: Team Comparison (only if multi-team) -->
    {% if is_multi_team %}
    <div class="tab-content" id="team-comparison">
        <div class="comparison-intro">
            <h4>‚ÑπÔ∏è Multi-Team Bonus Normalization</h4>
            <p>
                When calculating bonuses across multiple teams, normalization happens at the organization level.
                This means budget may shift between teams based on their performance distribution.
                Teams with concentrated high performers may receive additional budget from teams with more modest distributions.
            </p>
        </div>

        <h3>Team-Level vs Organization-Level Comparison</h3>
        <div style="overflow-x: auto;">
            <table class="team-comparison-table">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th class="right">Employees</th>
                        <th class="right">Total Pool</th>
                        <th class="right">Avg Rating</th>
                        <th class="right">Team-Level Norm</th>
                        <th class="right">Org-Level Norm</th>
                        <th class="right">Budget Impact</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for comparison in team_comparisons %}
                    <tr>
                        <td><strong>{{ comparison.team_name }}</strong></td>
                        <td class="right">{{ comparison.employee_count }}</td>
                        <td class="right">${{ "{:,.0f}".format(comparison.team_pool) }}</td>
                        <td class="right">{{ comparison.avg_rating }}%</td>
                        <td class="right">{{ "%.3f"|format(comparison.team_norm) }}</td>
                        <td class="right">{{ "%.3f"|format(comparison.org_norm) }}</td>
                        <td class="right">
                            <span class="{% if comparison.budget_impact > 0 %}status-gain{% elif comparison.budget_impact < 0 %}status-loss{% else %}status-neutral{% endif %}">
                                {% if comparison.budget_impact > 0 %}+{% endif %}${{ "{:,.0f}".format(comparison.budget_impact) }}
                                ({% if comparison.impact_percent > 0 %}+{% endif %}{{ "%.1f"|format(comparison.impact_percent) }}%)
                            </span>
                        </td>
                        <td>
                            {% if comparison.budget_impact > 0 %}
                            <span class="status-gain">‚Üë Budget Gain</span>
                            {% elif comparison.budget_impact < 0 %}
                            <span class="status-loss">‚Üì Budget Loss</span>
                            {% else %}
                            <span class="status-neutral">= Neutral</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="methodology" style="margin-top: 20px;">
            <h4>üìã Understanding the Comparison</h4>
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li style="font-size: 13px; color: #555; margin: 5px 0; line-height: 1.5;">
                    <strong>Team-Level Norm:</strong> Normalization factor if the team was calculated in isolation
                </li>
                <li style="font-size: 13px; color: #555; margin: 5px 0; line-height: 1.5;">
                    <strong>Org-Level Norm:</strong> Actual normalization factor when all teams are combined
                </li>
                <li style="font-size: 13px; color: #555; margin: 5px 0; line-height: 1.5;">
                    <strong>Budget Impact:</strong> Dollar amount gained or lost due to organization-level normalization
                </li>
                <li style="font-size: 13px; color: #555; margin: 5px 0; line-height: 1.5;">
                    Teams with higher average ratings tend to gain budget, while teams with lower averages tend to contribute budget
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab 3: Detailed Breakdown (only if multi-team) -->
    <div class="tab-content" id="detailed">
        <div class="comparison-intro">
            <h4>‚ÑπÔ∏è Per-Employee Comparison</h4>
            <p>
                This view shows each employee's bonus under both team-level and organization-level calculations.
                The difference illustrates how organization-level normalization affects individual bonuses.
            </p>
        </div>

        {% for team in teams_data %}
        <h3>{{ team.name }} ({{ team.employees|length }} employees)</h3>
        <div style="overflow-x: auto; margin-bottom: 30px;">
            <table class="bonus-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th class="right">Rating %</th>
                        <th class="right">Team-Level Bonus</th>
                        <th class="right">Org-Level Bonus</th>
                        <th class="right">Difference</th>
                        <th class="right">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emp in team.employees %}
                    {% set emp_id = emp['Associate ID'] %}
                    {% if emp_id in team.team_level_calc.results_by_id and emp_id in team.org_level_calc.results_by_id %}
                    {% set team_bonus = team.team_level_calc.results_by_id[emp_id].final_bonus %}
                    {% set org_bonus = team.org_level_calc.results_by_id[emp_id].final_bonus %}
                    {% set diff = org_bonus - team_bonus %}
                    <tr>
                        <td><strong><span class="employee-name" data-employee-id="{{ emp['Associate ID'] }}">{{ emp.Associate }}</span></strong></td>
                        <td class="right">{{ "%.0f"|format(emp.performance_rating_percent) }}%</td>
                        <td class="right">${{ "{:,.0f}".format(team_bonus) }}</td>
                        <td class="right">${{ "{:,.0f}".format(org_bonus) }}</td>
                        <td class="right">
                            <span class="{% if diff > 0 %}status-gain{% elif diff < 0 %}status-loss{% else %}status-neutral{% endif %}">
                                {% if diff > 0 %}+{% endif %}${{ "{:,.0f}".format(diff) }}
                            </span>
                        </td>
                        <td class="right">
                            {% if diff > 0 %}
                            <span style="color: #27ae60;">‚Üë</span>
                            {% elif diff < 0 %}
                            <span style="color: #dc3545;">‚Üì</span>
                            {% else %}
                            <span style="color: #666;">=</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
{% if has_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Performance-to-Bonus Curve Chart
(function() {
    // Configuration from parameters
    const UPSIDE_EXP = {{ params.upside_exponent }};
    const DOWNSIDE_EXP = {{ params.downside_exponent }};
    const VALUE_PER_SHARE = {{ value_per_share | default(1.0) }};

    // Calculate performance multiplier (matches app.py algorithm)
    function calcPerfMultiplier(rating) {
        if (rating < 100) {
            return Math.pow(rating / 100, DOWNSIDE_EXP);
        } else {
            return Math.pow(rating / 100, UPSIDE_EXP);
        }
    }

    // Extract team data from bonus results
    const teamResults = {{ team | tojson }};

    // Generate curve data (0-200%)
    // Payout % = perf_multiplier * value_per_share * 100
    // This matches the backend calculation: (bonus_target * perf_multiplier * value_per_share) / bonus_target * 100
    const curveRatings = [];
    const curvePayouts = [];
    for (let r = 0; r <= 200; r += 2) {
        curveRatings.push(r);
        const payout = calcPerfMultiplier(r) * VALUE_PER_SHARE * 100;
        curvePayouts.push(payout);
    }

    // Group team members by rating to handle duplicates
    const teamPointsMap = new Map();
    teamResults.forEach(result => {
        const rating = result.rating;
        const payout = calcPerfMultiplier(rating) * VALUE_PER_SHARE * 100;
        const key = rating.toString();

        if (!teamPointsMap.has(key)) {
            teamPointsMap.set(key, {
                x: rating,
                y: payout,
                names: []
            });
        }
        teamPointsMap.get(key).names.push(result.employee.Associate);
    });

    const teamPoints = Array.from(teamPointsMap.values());

    // Calculate point radii based on number of people at each rating
    const pointRadii = teamPoints.map(point => {
        const count = point.names.length;
        // Base radius of 6, add 2 pixels for each additional person, max at 16
        return Math.min(6 + (count - 1) * 2, 16);
    });

    const pointHoverRadii = pointRadii.map(r => r + 2);

    const bonusCurveCtx = document.getElementById('bonusCurveChart').getContext('2d');
    new Chart(bonusCurveCtx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'Performance Curve',
                    data: curveRatings.map((r, i) => ({ x: r, y: curvePayouts[i] })),
                    borderColor: '#0056b3',
                    backgroundColor: 'rgba(0, 86, 179, 0.1)',
                    borderWidth: 3,
                    pointRadius: 0,
                    fill: false
                },
                {
                    label: 'Your Team Members',
                    data: teamPoints,
                    borderColor: '#dc3545',
                    backgroundColor: '#dc3545',
                    pointRadius: pointRadii,
                    pointHoverRadius: pointHoverRadii,
                    showLine: false
                },
                {
                    label: 'Linear (1:1)',
                    data: [{x: 0, y: 0}, {x: 200, y: 200}],
                    borderColor: '#999',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    min: 0,
                    max: 200,
                    title: {
                        display: true,
                        text: 'Performance Rating (%)',
                        font: { size: 14, weight: 'bold' }
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        drawOnChartArea: true,
                        color: function(context) {
                            if (context.tick.value === 100) {
                                return 'rgba(0, 0, 0, 0.3)';
                            }
                            return 'rgba(0, 0, 0, 0.1)';
                        }
                    }
                },
                y: {
                    min: 0,
                    max: 200,
                    title: {
                        display: true,
                        text: 'Final Bonus Payout (% of Target)',
                        font: { size: 14, weight: 'bold' }
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        drawOnChartArea: true,
                        color: function(context) {
                            if (context.tick.value === 100) {
                                return 'rgba(0, 0, 0, 0.3)';
                            }
                            return 'rgba(0, 0, 0, 0.1)';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            if (context[0].dataset.label === 'Your Team Members') {
                                const dataPoint = context[0].raw;
                                const names = dataPoint.names;
                                if (names.length === 1) {
                                    return names[0];
                                } else {
                                    return names; // Chart.js will display as array
                                }
                            }
                            return '';
                        },
                        label: function(context) {
                            if (context.dataset.label === 'Your Team Members') {
                                const dataPoint = context.raw;
                                const count = dataPoint.names.length;
                                const countText = count > 1 ? ` (${count} people)` : '';
                                return `Rating: ${context.parsed.x.toFixed(0)}% ‚Üí Payout: ${context.parsed.y.toFixed(1)}% of target${countText}`;
                            }
                            return context.dataset.label;
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Performance-to-Bonus Curve',
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    padding: {
                        bottom: 20
                    }
                }
            }
        }
    });
})();

// Table sorting for Bonus Results
document.addEventListener('DOMContentLoaded', function() {
    const headers = document.querySelectorAll('th.sortable');
    let currentSort = { column: 'final', direction: 'desc' };

    headers.forEach(header => {
        header.addEventListener('click', function() {
            const sortKey = this.getAttribute('data-sort');
            sortBonusTable(sortKey);
        });
    });

    function sortBonusTable(column) {
        const table = document.querySelector('.bonus-table tbody');
        const rows = Array.from(table.querySelectorAll('tr'));

        // Toggle direction if same column, otherwise default to descending
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = (column === 'name' || column === 'job') ? 'asc' : 'desc';
        }

        // Update header classes
        document.querySelectorAll('th.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
        });
        document.querySelector(`th[data-sort="${column}"]`).classList.add(currentSort.direction);

        // Sort rows
        rows.sort((a, b) => {
            let aVal = a.getAttribute(`data-${column}`);
            let bVal = b.getAttribute(`data-${column}`);

            // Convert to numbers for numeric columns
            if (column !== 'name' && column !== 'job') {
                aVal = parseFloat(aVal);
                bVal = parseFloat(bVal);
            }

            if (currentSort.direction === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        // Re-append rows in sorted order
        rows.forEach(row => table.appendChild(row));
    }

    // Set initial sort indicator (sorted by Final Bonus descending)
    document.querySelector('th[data-sort="final"]').classList.add('desc');

    // Tab switching functionality (only if multi-team)
    {% if is_multi_team %}
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');

            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add active class to clicked button and corresponding content
            this.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
        });
    });
    {% endif %}
});

// Budget override auto-save functionality
let budgetOverrideSaveTimer = null;

function saveBudgetOverride(value) {
    const indicator = document.getElementById('budget-save-indicator');

    fetch('/api/bonus-settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            budget_override_usd: value
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Show save indicator
            indicator.style.opacity = '1';
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 2000);

            // Reload page to show updated bonuses
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            console.error('Error saving budget override:', result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Set up budget override input auto-save
const budgetOverrideInput = document.getElementById('budget_override_input');
if (budgetOverrideInput) {
    budgetOverrideInput.addEventListener('input', function() {
        // Clear existing timer
        if (budgetOverrideSaveTimer) {
            clearTimeout(budgetOverrideSaveTimer);
        }

        // Set new timer - save after 2 seconds of inactivity
        budgetOverrideSaveTimer = setTimeout(() => {
            saveBudgetOverride(this.value);
        }, 2000);
    });

    // Also save on blur (when leaving the field)
    budgetOverrideInput.addEventListener('blur', function() {
        if (budgetOverrideSaveTimer) {
            clearTimeout(budgetOverrideSaveTimer);
        }
        saveBudgetOverride(this.value);
    });
}
</script>
{% endif %}
{% endblock %}
