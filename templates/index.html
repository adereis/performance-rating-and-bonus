{% extends "base.html" %}

{% block title %}Dashboard - Performance Rating{% endblock %}

{% block extra_css %}
<style>
    th.sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 25px;
    }

    th.sortable:hover {
        background: #e8e9ea;
    }

    th.sortable::after {
        content: '⇅';
        position: absolute;
        right: 8px;
        opacity: 0.3;
        font-size: 12px;
    }

    th.sortable.asc::after {
        content: '↑';
        opacity: 1;
    }

    th.sortable.desc::after {
        content: '↓';
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <h3>Total Employees</h3>
        <div class="number">{{ stats.total }}</div>
    </div>
    <div class="stat-card">
        <h3>Rated</h3>
        <div class="number">{{ stats.rated }}</div>
    </div>
    <div class="stat-card">
        <h3>Pending</h3>
        <div class="number">{{ stats.unrated }}</div>
    </div>
</div>

<div class="card">
    <h2>Team Overview</h2>
    <div style="overflow-x: auto;">
        <table id="teamTable">
            <thead>
                <tr>
                    <th class="sortable" data-sort="name">Name</th>
                    <th class="sortable" data-sort="job">Job Profile</th>
                    <th class="sortable" data-sort="rating">Performance Rating %</th>
                    <th class="sortable" data-sort="updated">Last Updated</th>
                </tr>
            </thead>
            <tbody id="teamTableBody">
                {% for employee in team %}
                <tr data-name="{{ employee.Associate }}"
                    data-job="{{ employee['Current Job Profile'] }}"
                    data-rating="{{ employee.performance_rating_percent or 0 }}"
                    data-updated="{{ employee.last_updated or '' }}">
                    <td><span class="employee-name" data-employee-id="{{ employee['Associate ID'] }}">{{ employee.Associate }}</span></td>
                    <td>{{ employee['Current Job Profile'] }}</td>
                    <td>
                        {% if employee.performance_rating_percent %}
                            <span style="color: #27ae60; font-weight: 600;">{{ employee.performance_rating_percent }}%</span>
                        {% else %}
                            <span style="color: #999;">Not rated</span>
                        {% endif %}
                    </td>
                    <td>{{ employee.last_updated if employee.last_updated else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card">
    <h2>Quick Actions</h2>
    <a href="{{ url_for('rate_page') }}" class="btn">Rate Team Members</a>
    <a href="{{ url_for('analytics') }}" class="btn">View Analytics</a>
</div>

<script>
// Table sorting functionality
let currentSort = { column: null, direction: 'asc' };

document.addEventListener('DOMContentLoaded', function() {
    const headers = document.querySelectorAll('th.sortable');

    headers.forEach(header => {
        header.addEventListener('click', function() {
            const sortKey = this.getAttribute('data-sort');
            sortTable(sortKey);
        });
    });
});

function sortTable(column) {
    const tbody = document.getElementById('teamTableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    // Toggle direction if same column, otherwise reset to ascending
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.direction = 'asc';
    }
    currentSort.column = column;

    // Update header classes
    document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
    });
    document.querySelector(`th[data-sort="${column}"]`).classList.add(currentSort.direction);

    // Sort rows
    rows.sort((a, b) => {
        let aVal = a.getAttribute(`data-${column}`);
        let bVal = b.getAttribute(`data-${column}`);

        // Handle numeric columns
        if (column === 'rating') {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
        }

        // Handle date column
        if (column === 'updated') {
            aVal = aVal || '0000-00-00';
            bVal = bVal || '0000-00-00';
        }

        let comparison = 0;
        if (aVal > bVal) comparison = 1;
        if (aVal < bVal) comparison = -1;

        return currentSort.direction === 'asc' ? comparison : -comparison;
    });

    // Re-append rows in sorted order
    rows.forEach(row => tbody.appendChild(row));
}
</script>
{% endblock %}
